package us.spotco.malwarescanner;

import android.accessibilityservice.AccessibilityService;
import android.app.Notification;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.content.Context;
import android.os.Build;
import android.view.accessibility.AccessibilityEvent;
import android.view.accessibility.AccessibilityNodeInfo;

import java.util.Random;
import java.util.concurrent.ConcurrentSkipListSet;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class LinkScannerService extends AccessibilityService {

    private static final String hostnameRegex = "^((?!-)[A-Za-z0-9-]{1,63}(?<!-)\\.)+[A-Za-z]{2,6}$"; //Credit: http://www.mkyong.com/regular-expressions/domain-name-regular-expression-example/
    private static final Pattern hostnamePattern = Pattern.compile(hostnameRegex);
    private static final ConcurrentSkipListSet<Integer> scannedObjects = new ConcurrentSkipListSet<>();
    private static final ConcurrentSkipListSet<String> scannedDomains = new ConcurrentSkipListSet<>();
    private NotificationManager notificationManager = null;

    @Override
    public void onServiceConnected() {
        notificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            NotificationChannel detectionChannel = new NotificationChannel("DETECTION", getString(R.string.lblNotificationMalwareDetectionTitle), NotificationManager.IMPORTANCE_HIGH);
            detectionChannel.setDescription(getString(R.string.lblNotificationMalwareDetectionDescription));
            notificationManager.createNotificationChannel(detectionChannel);
        }
    }

    @Override
    public void onAccessibilityEvent(AccessibilityEvent event) {
        if (Database.isDomainDatabaseLoaded()) {
            scanViews(event.getSource());
        }
    }

    @Override
    public void onInterrupt() {
    }

    private void scanViews(AccessibilityNodeInfo mNodeInfo) {
        try {
            //May already be gone
            if (mNodeInfo == null) {
                return;
            }

            //Don't scan if we already did
            int hash = mNodeInfo.toString().hashCode();
            if (scannedObjects.contains(hash)) {
                return;
            } else {
                scannedObjects.add(hash);
            }

            //Get and check the text
            String text = (String) mNodeInfo.getText();
            if (text != null && text.contains(".")) {
                scanText(text.toLowerCase());
            }

            //Finish if no more children
            if (mNodeInfo.getChildCount() < 1) {
                return;
            }

            //Recurse into the children otherwise
            for (int i = 0; i < mNodeInfo.getChildCount(); i++) {
                scanViews(mNodeInfo.getChild(i));
            }
        } catch (Exception ignored) {
        }
    }

    private void scanText(String haystack) {
        Matcher matcher = hostnamePattern.matcher(haystack);
        while (matcher.find()) {
            if (!scannedDomains.contains(matcher.group())) {
                scannedDomains.add(matcher.group());
                if (Database.domains.mightContain(matcher.group())) {
                    sendNotification(matcher.group());
                }
            }
        }
        if (haystack.contains("/")) {
            for (String split : haystack.split("/")) {
                scanText(split);
            }
        }
    }

    private void sendNotification(String link) {
        link = link.replaceAll("\\.", "[.]");
        Notification.Builder mBuilder =
                new Notification.Builder(this)
                        .setSmallIcon(R.drawable.ic_notification)
                        .setContentTitle(getText(R.string.lblNotificationLinkDetection))
                        .setContentText("Domain: >>>" + link + "<<<")
                        .setStyle(new Notification.BigTextStyle().bigText("Domain: >>>" + link + "<<<"))
                        .setPriority(Notification.PRIORITY_MAX)
                        .setDefaults(Notification.DEFAULT_VIBRATE);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
            mBuilder.setVisibility(Notification.VISIBILITY_SECRET);
        }
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            mBuilder.setChannelId("DETECTION");
        }
        notificationManager.notify(new Random().nextInt(), mBuilder.build());
    }

}
